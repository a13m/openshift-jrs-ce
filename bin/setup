#!/bin/bash
# Adapted from https://github.com/kr/heroku-buildpack-go
#

source $OPENSHIFT_CARTRIDGE_SDK_BASH

# Environment variable definitions
JRS_NAME="JasperReports Server"
JRS_EDITION="CE"
JRS_DOWNLOAD_HOST="http://d1zrxsx5g57hp8.cloudfront.net"

mkdir -p "./cache"
cache=$(cd "cache/" && pwd)
ver=${JRS_VERSION:-5.2.0}
file=${JRS_FILE:-jasperreports-server-cp-$ver-bin.zip}
jrs_url=${JRS_URL:-$JRS_DOWNLOAD_HOST/$file}
buildpack=$(dirname $(dirname $0))

if test -d $cache/jrs-$ver
then
    echo "-----> Using $JRS_NAME $JRS_EDITION $ver"
else
    mkdir -p $cache/jrs-$ver
    cd $cache/jrs-$ver
    echo    "       Initial download, may take several minutes"
    echo -n "-----> Downloading $JRS_NAME $JRS_EDITION $ver ..."
    curl -sO $jrs_url
    unzip -q $file
    echo " done"
fi

JRS_ROOT=$cache/jrs-$ver export JRS_ROOT
JRS_BUILDOMATIC=$JRS_ROOT/jasperreports-server-$ver-bin/buildomatic export JRS_BUILDOMATIC

echo $JRS_ROOT > $OPENSHIFT_JRS_DIR/env/JRS_ROOT
echo $JRS_BUILDOMATIC > $OPENSHIFT_JRS_DIR/env/JRS_BUILDOMATIC

echo "passed setup" > $OPENSHIFT_JRS_DIR/logs/install.log
